variables:
  - name: project_name
    value: Tobor
  - name: USE_ARTIFICIAL_BUILD_DEPENDENCIES
    value: true

trigger:
  branches:
    include:
      - '*'   # quoting not required for '*'
    exclude:
      - artifacts

stages:

# ============================================================
#  Stage: Compile & Test
# ============================================================
- stage: Compile_and_Test
  dependsOn: []

  jobs:

  # ------------------------------------------------------------
  #  Job: Qt 6 + Clang 17 (Linux only)
  # ------------------------------------------------------------
  - job: Qt_6___Clang_17
    ${{ if eq(variables.USE_ARTIFICIAL_BUILD_DEPENDENCIES, true) }}:
      dependsOn: [Qt_6]

    timeoutInMinutes: 30

    strategy:
      matrix:
        ubuntu_latest:
          imageName: ubuntu-latest
          the_name: Azure Pipelines
        ubuntu_22_04:
          imageName: ubuntu-22.04
          the_name: Azure Pipelines

    pool:
      vmImage: $(imageName)
      name: $(the_name)

    steps:
      - script: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x ./llvm.sh
          sudo ./llvm.sh 17
        displayName: Install Clang 17

      - script: sudo apt-get update && sudo apt-get install -y \
          build-essential libgl1-mesa-dev qt6-base-dev libqt6svg6 \
          libqt6svg6-dev libtbb-dev
        displayName: Install Qt (Linux)

      - script: git submodule update --init --recursive
        displayName: Init Git Submodules

      - script: |
          export CC=/usr/bin/clang-17
          export CXX=/usr/bin/clang++-17
          cmake -S . -B build
        displayName: CMake Configure (Clang 17)

      - script: cmake --build build --config Debug --verbose
        displayName: Build Debug

      - script: cmake --build build --config Release --verbose
        displayName: Build Release

      - script: ./build/test/TEST-$(project_name)
        displayName: Run Tests (Linux)


  # ------------------------------------------------------------
  #  Job: Qt 6 (Linux, macOS, Windows)
  # ------------------------------------------------------------
  - job: Qt_6
    timeoutInMinutes: 30

    strategy:
      matrix:
        ubuntu_latest:
          imageName: ubuntu-latest
          the_name: Azure Pipelines
        ubuntu_22_04:
          imageName: ubuntu-22.04
          the_name: Azure Pipelines
        macOS_latest:
          imageName: macOS-latest
          the_name: Azure Pipelines
        macOS_14:
          imageName: macOS-14
          the_name: Azure Pipelines
        windows_latest:
          imageName: windows-latest
          the_name: Azure Pipelines
        windows_2022:
          imageName: windows-2022
          the_name: Azure Pipelines

    pool:
      vmImage: $(imageName)
      name: $(the_name)

    steps:

      # Linux Qt
      - script: sudo apt-get update && sudo apt-get install -y \
          build-essential libgl1-mesa-dev qt6-base-dev libqt6svg6 \
          libqt6svg6-dev libtbb-dev
        displayName: Install Qt (Linux)
        condition: eq(variables['Agent.OS'], 'Linux')

      # macOS Qt
      - script: brew install qt@6 tbb
        displayName: Install Qt (macOS)
        condition: eq(variables['Agent.OS'], 'Darwin')

      # Windows Qt
      - script: |
          pip install aqtinstall
          mkdir C:\Qt
          aqt install-qt --outputdir C:\Qt windows desktop 6.5.1 win64_msvc2019_64
        displayName: Install Qt (Windows)
        condition: eq(variables['Agent.OS'], 'Windows_NT')

      - script: git submodule update --init --recursive
        displayName: Init Git Submodules

      # Configure
      - script: cmake -S . -B build -DCMAKE_PREFIX_PATH="C:\Qt\6.5.1\msvc2019_64"
        displayName: CMake Configure (Windows)
        condition: eq(variables['Agent.OS'], 'Windows_NT')

      - script: cmake -S . -B build
        displayName: CMake Configure (Unix)
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      # Build
      - script: cmake --build build --config Debug --verbose
        displayName: Build Debug

      - script: cmake --build build --config Release --verbose
        displayName: Build Release

      # Tests
      - script: ./build/test/TEST-$(project_name)
        displayName: Run Tests (Unix)
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - script: tree /F build
        displayName: Inspect Build Tree (Windows)
        condition: eq(variables['Agent.OS'], 'Windows_NT')

      - script: build\test\Release\TEST-$(project_name).exe
        displayName: Run Tests (Windows)
        condition: eq(variables['Agent.OS'], 'Windows_NT')


# ============================================================
#  Stage: Docs
# ============================================================
- stage: Docs
  dependsOn: []   # optionally: [Compile_and_Test]

  jobs:
    - job: dependency_diagram
      timeoutInMinutes: 30

      strategy:
        matrix:
          ubuntu_latest:
            imageName: ubuntu-latest
            the_name: Azure Pipelines

      pool:
        vmImage: $(imageName)
        name: $(the_name)

      steps:
        - script: git fetch
          displayName: git fetch

        - script: |
            echo "Build.SourceVersion: $(Build.SourceVersion)"
            echo "Build.SourceVersionMessage: $(Build.SourceVersionMessage)"
            echo "Extracted merge commit:"
            echo "$(Build.SourceVersionMessage)" | grep -Po '(?<=[Mm]erge )[0-9a-f]+(?= into)' || echo "Extraction failed"
            echo "Fallback commit:"
            echo "$(Build.SourceVersion)"
          displayName: Inspect Commit Info

        - script: |
            ./script/ci/create-deploy-include-dependency-graph.sh \
              "$(GIT_USERNAME)" \
              "$(GIT_ACCESS_TOKEN)" \
              "$(System.PullRequest.PullRequestNumber)" \
              "$(echo "$(Build.SourceVersionMessage)" | grep -Po '(?<=[Mm]erge )[0-9a-f]+(?= into)' || echo "$(Build.SourceVersion)")"
          displayName: Create & Deploy Dependency Graph
